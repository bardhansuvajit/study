YOUTUBE VIDEO
https://www.youtube.com/watch?v=8Wci1gGsuNk&list=PLSe91q1rf5vV-gTi0zJTz1BNvnb0x426p&index=1


PREREQUISITES
SSH/ Secure Shell/ Secure remote login - a network protocol that lets you securely connect to another computer/server over a network.

Understand command
sudo yum -y install httpd, means
sudo > Runs command as administrator/root.
yum > The package manager for RHEL-based systems (like: Amazon Linux, CentOS, Red Hat (RHEL), Rocky Linux, AlmaLinux).
-y > Automatically answers "yes" to all prompts (so it installs without asking you).
install httpd > Installs Apache Web Server (package name: httpd).

CI-CD
DevOps practice to automate the software development, testing and deployment process.
Developer pushes code → GitHub > CI runs tests → Jenkins/GitHub Actions > If tests pass → CD deploys to AWS server automatically

CI - Continuous Integration/ Automated Testing > Devs push codes, code gets automatically built,tested,checekd for errors,merged safely > Tools used Github action, Jenkins, Gitlab CI, Bitbucket Pipelines
CD - Continuous Delivery / Deployment / AUtomated Deployment > After CI passes, CD automates deploying the code. 2 types
Continuous Delivery > code is automatically tested & ready for deployment, but you still hit a button to deploy > Manual approval required.
Continuous Deployment > Fully automated deployment to production > No human involvement - code goes live automatically after tests pass.







================****************================
TUTORIAL START HERE
================****************================
STEPS
create Laravel app > Dockerise it > install composer packages > run tests inside docker container > install Jenkins > Jenkins CI/CD pipeline > pipeline will spin up the docker containers, run tests > create ARtifact, Zip the app, populate .env, then copy the artifact over AWS EC2 instance > unzip there & app will be available




BASICS
Docker
What: A containerization platform that packages an application and its dependencies into lightweight, portable containers.
Why: Ensures consistent environments, easy deployment, faster setup, and scalability.

Jenkins
What: An open-source automation server used to build, test, and deploy applications.
Why: Automates repetitive DevOps tasks and acts as the backbone for CI/CD pipelines.

CI/CD
CI (Continuous Integration): Developers frequently merge code; automated builds/tests run to catch issues early.
CD (Continuous Delivery/Deployment): Automates releasing code to staging/production after CI passes.
Why: Improves code quality, reduces manual errors, speeds up releases, and ensures reliable deployments.




PROBLEM
Deployment takes time. once the app is live, doing changes after that is hectic. like pulling repo, install packages, dependencies, testing etc in live is scary
OR, use a machine into a Build Machine




INSTALL PACKAGES
use Manjaro distro for linux, IF POSSIBLE

update packages - 
sudo pacman -Su (pacman is the package manager -su means sync & upgrade installed packages) (OR sudo pacman -Syu)

install snap repository
sudo pacman -S snapd (installs snapd from the official Arch/Manjaro software repository.)

enable snap repo
sudo systemctl enable --now snapd.socket (enable → makes the service start automatically on boot | --now → start immediately | snapd.socket → the socket unit that triggers the Snap daemon when needed)

create a symlink (symlink is a pointer or shortcut to another file or folder.)
sudo ln -s /var/lib/snapd/snap /snap (creates a shortcut from /var/lib/snapd/snap to /snap so Snap apps can run normally on system)

install VScode, google vscode snap
sudo snap install code --classic

installing Docker through pacman
sudo pacman -S docker
enable & start the docker service
sudo systemctl start docker.service
sudo systemctl enable docker.service

now docker has created a group, add current logged-in user needs to be in the group 
sudo usermod -aG docker $USER

install docker compose, which is a separate application here
sudo pacman -S docker-compose

sudo reboot



PROJECT BOILERPLATE
get dockerfiles & docker-compose.yml from here
https://github.com/thecaringdeveloper/laravel-cicd-tutorial

mkdir workspace > cd workspace > git clone... > cd demo-project
docker compose up - now the containers are running
install laravel app now
docker-compose run composer create-project laravel/laravel some-project-name "8.0.*" --prefer-dist

NOW, 
demo-project
    |---dockerfiles
    |---docker-compose.yml
    |---some-project-name (laravel app)
move everything from "some-project-name" to "demo-project" folder
mv ./some-project-name/* ./ (move all files)
mv ./some-project-name/.* ./ (move hidden files)
rm -rf some-project-name

test if everything is working
docker-compose run artisan test




INSTALL JAVA & JENKINS & SETUP ADMIN ACCOUNT
JAVA
sudo pacman -S jre8-openjdk-headless jre8-openjdk jdk8-openjdk openjdk8-doc openjdk8-src
JENKINS
sudo pacman -S jenkins, if doesnt work, update packages first, sudo pacman -Sy (OR sudo pacman -Syu)
start jenkins
sudo systemctl start jenkins

to check goto, the page will ask for initialAdminPassword
http://localhost:8090

to get the initialAdminPassword
sudo cat /var/lib/jenkins/secrets/initialAdminPassword (u can get this path from jenkins page)
copy & use the password > install suggested plugins > create admin user > 'admin' & 'admin', test email & name, keep the URL same http://localhost:8090 > Jenkins dashboard

Jenkins is a tool to create pipelines, deploy, run tests etc.




GIHUB REPO SETUP
create new repo > private
set new repo in local
git remote set-url origin git@github.com:bardhansuvajit/laravel-ci-cd-project.git
git config --global user.email bardhansuvajit@gmail.com
git config --global user.name suvajit
git add *
git commit -m 'laravel project'
git push




ADD JENKINS USER TO DOCKER GROUP
that will ensure the jenkins user can control the docker containers
sudo usermod -aG docker jenkins

create jenkins file & create ci/cd pipeline in jenkins. these pipeline will find the jenkins file inside github repo and will be used to drive the ci/cd pipeline




PIPELEINE INITIAL SETUP
create jenkins file, makefile, credentials for github in jenkins (so jenkins can pull our project), create & populate .env file in workspace, install some file operations, some plugins
then restart jenkins

open the project in vscode
create "Jenkinsfile" in root & paste content from the Github Repo

goto Jenkins link, http://localhost:8090
Manage Jenkins > Manage Credentials > Domains > (global) > Add Credentials

New credentials >
SSH username with Private Key > ID - github > Username - some-project
Private key - Enter directly - use private SSH key
create

** If u dont have SSH key setup in system 
- ssh-keygen -t ed25519 -C "your_email@example.com"         (generate the key - 2keys will be generated, public & private)
- type C:\Users\user\.ssh\id_ed25519.pub                    (get/ copy the public key)
- copy & use the whole code in Github account SSH key

Create Pipeline
Enter name, desc > Definition - Pipeline script from SCM > SCM - git > Repository URL - use SSH url from github repo
select credentails > Branch - main > Script Path - Jenkinsfile - SAVE

Now, try 'Build now' from Jenkins & try to 'Commit'
as needed try, 
sudo systemctl restart jenkins
sudo systemctl restart docker.service




MAKEFILE
create Makefile in root - copy contents from github repo
now try 'make up' command, install make if needed

Create the .env file in jenkins directory
if the build error says something like, MissingAppKeyException
in the Jenkins Console Output, check where the Jenkins is running, 
most likely its on /var/lib/jenkins/workspace/LaravelTest
so create a folder here, sudo mkdir /var/lib/jenkins/workspace/envs && sudo mkdir /var/lib/jenkins/workspace/envs/demo-project-1
edit .env - sudo nano /var/lib/jenkins/workspace/envs/demo-project-1/.env (copy from project directory .env & paste here)
in demo-project/Jenkinsfile, check the "Populate .env file" directory
Push & Build, this should succeed




AWS EC2 INSTANCE
New/ Launch instance > "Laravel cicd-test", name > Create key pair > "key-for-ec2-laravel-cicd-test", name > RSA, .pem > Create
Load the key in Jenkins
terminal > cat ~/.ssh/key-for-ec2-laravel-cicd-test.pem > get key content OR use GUI
Manage Jenkins > Manage Credentials > Domains > (global) > Add Credentials

New credentials >
SSH username with Private Key > ID - aws-ec2 > Username - some-project
Private key - Enter directly - use private SSH key
create

Change Access Level of the file (else while checking connection, it might throw error)
Terminal > chmod 400 ~/.ssh/key-for-ec2-laravel-cicd-test.pem

**********
Check SSH Connection
AWS EC2 Instance - just created instance, copy the example like, ssh -i "key-for-ec2-laravel-cicd-test.pem" ec2-user@ec2-13-40-116-143.eu-west-2.compute.amazonaws.com
Terminal > 
ssh -i "~/.ssh/key-for-ec2-laravel-cicd-test.pem" ec2-user@ec2-13-40-116-143.eu-west-2.compute.amazonaws.com

if all ok, then we are successfully connected SSH to EC2 Instace 
now, we want Jenkins to do the same. Then verufy SSH connection. If the connection fails, the pipeline wont continue, else do

Jenkins
Manage Jenkins > Manage Plugins > search "SSH agent" > Download Install & Restart > check "Restart Jenkins when installation is complete and no jobs are running"

**********
in demo-project/Jenkinsfile, check the "Verify SSH connection to server"
ssh -o StrictHostKeyChecking=no ec2-user@13.41.191.171 whoami (Change the IP "13.41.191.171" with EC2 instance public IPV4 address)




ARTIFACT (ZIP)
in our project folder zip everything, except node_modules (dont do anything, already written in Jenkinsfile)
if, zip command not found, install zip (Terminal > zip)
Build with Jenkins, artiface.zip should be created




DEPLOY
connect to EC2 using SSH
ssh -i "~/.ssh/key-for-ec2-laravel-cicd-test.pem" ec2-user@ec2-13-40-116-143.eu-west-2.compute.amazonaws.com (>>>>>>now should be inside ec2)
> mkdir artifact > cd artifact
> pwd (print current directory) > /home/ec2-user/artifact
> exit

copy the artifact file in EC2 
> check this section 'withCredentials' is added in Jenkinsfile
> after this section is added/ fixed as per project need, artifact.zip should be in ec2 instance > check



DEPLOY 2 + FINISH
unzip file, install web server (php/ apache), and a few packages in EC2 instance, as there is nothiung to serve the application

install Apache
connect to EC2 using SSH
ssh -i "~/.ssh/key-for-ec2-laravel-cicd-test.pem" ec2-user@ec2-13-40-116-143.eu-west-2.compute.amazonaws.com (>>>>>>now should be inside ec2)
> sudo yum -y install httpd (install apache)
> sudo service httpd start (legacy)/ sudo systemctl start httpd (modern) (start apache)
> sudo chown ec2-user:ec2-user /var/www/html/ (update owner of the folder apache is serving from, so that our EC2 user can copy things, not apache)
Now, to verify it open the IP, e.g. 13.40.116.143 (can be found in EC2 instance summary)

**********
If, opening the IP, doesn't load/ do anything, update inbound rules
Goto Security > Security group > select the one > Edit "Inbound Rules"
SSH - Custom - 0.0.0.0/00
All TCP - Anywhere-IPv4 - 0.0.0.0/00
Save
Now, the instance IP (e.g. 13.40.116.143) should show, "Unable to connect", this is better than not showing anything/ keep loading, as we have no running application

install PHP
sudo amazon-linux-extras list | grep php (list available php versions)
sudo yum clean metadata (Clears YUM's repository metadata cache)
sudo yum install -y php-{pear,cgi,pdo,common,curl,mbstring,gd,mysqlnd,gettext,bcmath,json,xml,fpm,intl,zip} (install PHP)
php -v

update document root in httpd.conf file
cd /etc/httpd/conf > ls (u should see httpd.conf)
sudo nano httpd.conf (save & exit)

verify unzip command is avilable (> unzip)














================****************================
Jenkinsfile
================****************================
pipeline {
    agent any
    stages {
        stage("Verify tooling") {
            steps {
                sh '''
                    docker info
                    docker version
                    docker compose version
                '''
            }
        }
        stage("Verify SSH connection to server") {
            steps {
                sshagent(credentials: ['aws-ec2']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ec2-user@13.40.116.143 whoami
                    '''
                }
            }
        }        
        stage("Clear all running docker containers") {
            steps {
                script {
                    try {
                        sh 'docker rm -f $(docker ps -a -q)'
                    } catch (Exception e) {
                        echo 'No running container to clear up...'
                    }
                }
            }
        }
        stage("Start Docker") {
            steps {
                sh 'make up'
                sh 'docker compose ps'
            }
        }
        stage("Run Composer Install") {
            steps {
                sh 'docker compose run --rm composer install'
            }
        }
        stage("Populate .env file") {
            steps {
                dir("/var/lib/jenkins/workspace/envs/laravel-test") {
                    fileOperations([fileCopyOperation(excludes: '', flattenFiles: true, includes: '.env', targetLocation: "${WORKSPACE}")])
                }
            }
        }              
        stage("Run Tests") {
            steps {
                sh 'docker compose run --rm artisan test'
            }
        }
    }
    post {
        success {
            sh 'cd "/var/lib/jenkins/workspace/LaravelTest"'
            sh 'rm -rf artifact.zip'
            sh 'zip -r artifact.zip . -x "*node_modules**"'
            withCredentials([sshUserPrivateKey(credentialsId: "aws-ec2", keyFileVariable: 'keyfile')]) {
                sh 'scp -v -o StrictHostKeyChecking=no -i ${keyfile} /var/lib/jenkins/workspace/LaravelTest/artifact.zip ec2-user@13.40.116.143:/home/ec2-user/artifact'
            }
            sshagent(credentials: ['aws-ec2']) {
                sh 'ssh -o StrictHostKeyChecking=no ec2-user@13.40.116.143 unzip -o /home/ec2-user/artifact/artifact.zip -d /var/www/html'
                script {
                    try {
                        sh 'ssh -o StrictHostKeyChecking=no ec2-user@13.40.116.143 sudo chmod 777 /var/www/html/storage -R'
                    } catch (Exception e) {
                        echo 'Some file permissions could not be updated.'
                    }
                }
            }                                  
        }
        always {
            sh 'docker compose down --remove-orphans -v'
            sh 'docker compose ps'
        }
    }
}